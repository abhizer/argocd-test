apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
    name: argocd-tailscale-operator
    namespace: argocd
    annotations:
        argocd.argoproj.io/sync-wave: "15"
spec:
    project: default
    sources:
        - repoURL: "https://pkgs.tailscale.com/helmcharts"
          chart: tailscale-operator
          targetRevision: "1.90.5"
          helm:
              values: |
                  oauth: {}
                  operatorConfig:
                    defaultTags: "tag:ci-eks-operator"
                  proxyConfig:
                    defaultTags: "tag:ci-k8s"
                  apiServerProxyConfig:
                    mode: "noauth"
    destination:
        name: in-cluster
        namespace: tailscale
    syncPolicy:
        automated:
            prune: true
            selfHeal: true
        syncOptions:
            - CreateNamespace=true
---
# Patch ArgoCD to no longer be publicly reachable.
# Set annotations to make it accessible only through Tailscale.
apiVersion: v1
kind: Service
metadata:
    name: argo-cd-argocd-server
    namespace: argocd
    annotations:
        tailscale.com/expose: "true"
        tailscale.com/hostname: "argocd"
        argocd.argoproj.io/sync-wave: "20"
        argocd.argoproj.io/sync-options: "Replace=true"
spec:
    type: ClusterIP
    selector:
        app.kubernetes.io/name: argocd-server
    ports:
        - name: https
          port: 443
          targetPort: 8080
